<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Study Management App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tone.js for audio alerts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .tab-active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal-content {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from { transform: translateY(20%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container" class="max-w-4xl mx-auto p-4 min-h-screen">
        <!-- Header -->
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-gray-800">Study Planner Pro</h1>
            <p class="text-gray-500 mt-2">Apni padhai ko manage karein, smart tarike se.</p>
        </header>

        <!-- Loading state -->
        <div id="loading-indicator" class="text-center py-10">
            <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
            <p class="mt-4 text-gray-600">App load ho raha hai...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <main id="main-content" class="hidden">
            <!-- Navigation Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-2 sm:space-x-4" aria-label="Tabs">
                    <button class="tab-btn tab-active" data-tab="dashboard">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button class="tab-btn" data-tab="subjects">
                        <i class="fas fa-book mr-2"></i>Subjects & Tasks
                    </button>
                    <button class="tab-btn" data-tab="timer">
                        <i class="fas fa-clock mr-2"></i>Focus Timer
                    </button>
                    <button class="tab-btn" data-tab="reports">
                        <i class="fas fa-chart-pie mr-2"></i>Reports
                    </button>
                    <button class="tab-btn" data-tab="settings">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard-tab" class="tab-pane active-pane">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Welcome & Stats -->
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h2 class="text-2xl font-bold mb-4">Aaj ka Overview</h2>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600"><i class="fas fa-tasks mr-2 text-green-500"></i>Poore kiye gaye Tasks</span>
                                    <span id="completed-tasks-count" class="font-bold text-lg">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600"><i class="fas fa-hourglass-half mr-2 text-red-500"></i>Baaki Tasks</span>
                                    <span id="pending-tasks-count" class="font-bold text-lg">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600"><i class="fas fa-stopwatch mr-2 text-blue-500"></i>Total Padhai ka Samay</span>
                                    <span id="total-study-time" class="font-bold text-lg">0 min</span>
                                </div>
                            </div>
                        </div>
                         <!-- Today's Tasks -->
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h2 class="text-2xl font-bold mb-4">Aaj ke Tasks</h2>
                            <div id="todays-tasks-list" class="space-y-3 max-h-48 overflow-y-auto">
                                <!-- Tasks will be injected here -->
                                <p class="text-gray-500">Aaj ke liye koi task nahi hai.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Overall Progress -->
                    <div class="bg-white p-6 rounded-xl shadow-sm mt-6">
                        <h2 class="text-2xl font-bold mb-4">Overall Progress</h2>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="overall-progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <p id="overall-progress-text" class="text-center mt-2 text-gray-600">0% poora hua.</p>
                    </div>
                </div>

                <!-- Subjects & Tasks Tab -->
                <div id="subjects-tab" class="tab-pane hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Aapke Subjects</h2>
                        <button id="add-subject-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition">
                            <i class="fas fa-plus mr-2"></i>Naya Subject
                        </button>
                    </div>
                    <div id="subjects-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Subjects will be rendered here -->
                         <p id="no-subjects-msg" class="text-gray-500 col-span-full text-center py-10">Aapne abhi tak koi subject add nahi kiya hai.</p>
                    </div>
                </div>

                <!-- Focus Timer Tab -->
                <div id="timer-tab" class="tab-pane hidden">
                     <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto text-center">
                        <h2 class="text-2xl font-bold mb-4">Focus Timer (Pomodoro)</h2>
                        <div id="timer-display" class="text-8xl font-bold my-6 text-gray-800">25:00</div>
                        <div class="mb-6">
                            <label for="task-for-timer" class="block text-sm font-medium text-gray-700 mb-2">Focus karne ke liye Task chunein:</label>
                            <select id="task-for-timer" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="">Koi task nahi chuna</option>
                            </select>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button id="start-timer-btn" class="bg-green-500 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow hover:bg-green-600 transition"><i class="fas fa-play mr-2"></i>Start</button>
                            <button id="pause-timer-btn" class="bg-yellow-500 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow hover:bg-yellow-600 transition hidden"><i class="fas fa-pause mr-2"></i>Pause</button>
                            <button id="reset-timer-btn" class="bg-red-500 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow hover:bg-red-600 transition"><i class="fas fa-sync-alt mr-2"></i>Reset</button>
                        </div>
                        <p id="timer-status" class="mt-4 text-gray-600">Focus ka samay!</p>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports-tab" class="tab-pane hidden">
                    <h2 class="text-2xl font-bold mb-4">Aapki Study Report</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-semibold mb-3">Subject ke anusaar Padhai ka Samay</h3>
                        <canvas id="study-time-chart" height="150"></canvas>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-pane hidden">
                    <h2 class="text-2xl font-bold mb-4">Settings</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm space-y-4">
                        <div class="flex items-center justify-between">
                            <label for="enable-notifications" class="font-medium">Browser Notifications</label>
                            <button id="request-notification-permission" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Enable Karein</button>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="enable-sound" class="font-medium">Sound Alert</label>
                            <input type="checkbox" id="enable-sound" class="h-6 w-6 rounded text-blue-500 border-gray-300 focus:ring-blue-500">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="enable-vibration" class="font-medium">Vibration Alert (Mobile par)</label>
                            <input type="checkbox" id="enable-vibration" class="h-6 w-6 rounded text-blue-500 border-gray-300 focus:ring-blue-500">
                        </div>
                         <div class="pt-4 border-t">
                            <h3 class="font-semibold mb-2">User ID</h3>
                            <p class="text-sm text-gray-500">Apna data anya devices par access karne ke liye is ID ka upyog karein (future feature).</p>
                            <div class="mt-2 bg-gray-100 p-2 rounded-md text-center">
                                <code id="user-id-display" class="text-gray-700"></code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Subject Modal -->
    <div id="subject-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4" id="subject-modal-title">Naya Subject Jodein</h3>
            <form id="subject-form">
                <div>
                    <label for="subject-name" class="block text-sm font-medium text-gray-700">Subject ka Naam</label>
                    <input type="text" id="subject-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div class="mt-4">
                    <label for="subject-color" class="block text-sm font-medium text-gray-700">Ek Rang Chunein</label>
                    <input type="color" id="subject-color" class="mt-1 block w-full" value="#3b82f6">
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-subject-modal" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="task-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4" id="task-modal-title">Naya Task Jodein</h3>
            <form id="task-form">
                <input type="hidden" id="task-subject-id">
                <input type="hidden" id="task-id">
                <div>
                    <label for="task-name" class="block text-sm font-medium text-gray-700">Task ka Naam</label>
                    <input type="text" id="task-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div class="mt-4">
                    <label for="task-due-date" class="block text-sm font-medium text-gray-700">Due Date</label>
                    <input type="date" id="task-due-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-task-modal" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Save Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg p-8 w-full max-w-sm text-center shadow-2xl">
            <div id="custom-alert-icon" class="mb-4"></div>
            <h3 class="text-xl font-bold mb-2" id="custom-alert-title">Timer Poora Hua!</h3>
            <p class="text-gray-600 mb-6" id="custom-alert-message">Ab break lene ka samay hai.</p>
            <button id="close-alert-modal" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 w-full">Okay</button>
        </div>
    </div>


    <!-- Firebase SDK -->
   <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, collection, addDoc, getDocs, onSnapshot, 
            updateDoc, deleteDoc, query, where, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP STATE ---
        let db, auth;
        let userId = null;
        let subjects = [];
        let tasks = [];
        let studySessions = [];
        let studyTimeChart;

        // 1. __app_id को global (सबसे ऊपर) बनाया गया है ताकि सभी functions इसे इस्तेमाल कर सकें।
        const __app_id = "study-planner-pro";

        // --- FIREBASE SETUP ---
        // 2. initializeFirebase function को सिंटैक्स एरर के लिए ठीक किया गया है।
        function initializeFirebase() {
            try {
                // यहाँ आपकी Firebase कॉन्फ़िगरेशन है
                const firebaseConfig = {
                    apiKey: "AIzaSyApJFN9a_iqI5xKvhU20N6pkkmNe12Cb2s",
                    authDomain: "study-manage-83992.firebaseapp.com",
                    projectId: "study-manage-83992",
                    storageBucket: "study-manage-83992.firebasestorage.app",
                    messagingSenderId: "827804856712",
                    appId: "1:827804856712:web:2e5629989deb773eb6ca3d",
                    measurementId: "G-EFPR7MLJW5"
                };

                // Firebase ऐप को शुरू करें
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // यूजर के लॉग-इन स्टेटस को सुनें
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // अगर यूजर लॉग-इन है
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        await fetchAllData();
                        hideLoadingIndicator();
                    } else {
                        // अगर कोई यूजर लॉग-इन नहीं है, तो उसे चुपके से (anonymously) लॉग-इन कराएं
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Authentication error:", error);
                            showError("Authentication failed. Please refresh the page.");
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase initialization error:", e);
                showError("Could not connect to the database. Please check your connection and refresh.");
            }
        }
        
        function hideLoadingIndicator() {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        function showError(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.innerHTML = `<p class="text-red-500 font-bold p-4">${message}</p>`;
        }


        // --- DATA FETCHING & RENDERING ---
        async function fetchAllData() {
            if (!userId) return;
            const basePath = `artifacts/${__app_id}/users/${userId}`;

            // Subjects listener
            onSnapshot(collection(db, `${basePath}/subjects`), (snapshot) => {
                subjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSubjects();
                updateAllUI();
            });

            // Tasks listener
            onSnapshot(collection(db, `${basePath}/tasks`), (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllTasks();
                updateAllUI();
            });

            // Study Sessions listener
            onSnapshot(collection(db, `${basePath}/studySessions`), (snapshot) => {
                studySessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllUI();
            });
        }
        
        function updateAllUI() {
            renderDashboard();
            renderTimerTaskOptions();
            renderReports();
        }

        function renderSubjects() {
            const list = document.getElementById('subjects-list');
            const noSubjectsMsg = document.getElementById('no-subjects-msg');
            list.innerHTML = '';
            if (subjects.length === 0) {
                 noSubjectsMsg.classList.remove('hidden');
                return;
            }
            noSubjectsMsg.classList.add('hidden');

            subjects.forEach(subject => {
                const subjectTasks = tasks.filter(t => t.subjectId === subject.id);
                const completedTasks = subjectTasks.filter(t => t.isCompleted).length;
                const progress = subjectTasks.length > 0 ? (completedTasks / subjectTasks.length) * 100 : 0;

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm border-l-4';
                card.style.borderColor = subject.color;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-gray-800">${subject.name}</h3>
                        <div class="flex space-x-2 text-gray-400">
                           <button class="edit-subject-btn hover:text-blue-500" data-id="${subject.id}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-subject-btn hover:text-red-500" data-id="${subject.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">${completedTasks} / ${subjectTasks.length} tasks poore hue.</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                    <div class="mt-4">
                        <div class="task-list space-y-2" data-subject-id="${subject.id}"></div>
                    </div>
                    <button class="add-task-btn mt-3 text-blue-500 hover:text-blue-700 text-sm font-semibold" data-subject-id="${subject.id}">
                        <i class="fas fa-plus-circle mr-1"></i>Naya Task Jodein
                    </button>
                `;
                list.appendChild(card);
            });
            renderAllTasks();
        }

        function renderAllTasks() {
            document.querySelectorAll('.task-list').forEach(list => {
                const subjectId = list.dataset.subjectId;
                const subjectTasks = tasks.filter(t => t.subjectId === subjectId).sort((a,b) => a.isCompleted - b.isCompleted);
                list.innerHTML = '';
                if (subjectTasks.length > 0) {
                    subjectTasks.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-md';
                        taskEl.innerHTML = `
                            <div class="flex items-center">
                                <input type="checkbox" class="task-checkbox h-5 w-5 rounded text-blue-500 border-gray-300 focus:ring-blue-500 mr-3" data-id="${task.id}" ${task.isCompleted ? 'checked' : ''}>
                                <span class="${task.isCompleted ? 'line-through text-gray-400' : ''}">${task.name}</span>
                            </div>
                            <span class="text-xs text-gray-500">${task.dueDate}</span>
                        `;
                        list.appendChild(taskEl);
                    });
                } else {
                    list.innerHTML = `<p class="text-xs text-gray-400 italic">Is subject ke liye koi task nahi hai.</p>`;
                }
            });
        }
        
        function renderDashboard() {
            const completedTasks = tasks.filter(t => t.isCompleted).length;
            const pendingTasks = tasks.length - completedTasks;
            const totalStudyTime = studySessions.reduce((acc, s) => acc + s.duration, 0);
            const progress = tasks.length > 0 ? (completedTasks / tasks.length) * 100 : 0;

            document.getElementById('completed-tasks-count').textContent = completedTasks;
            document.getElementById('pending-tasks-count').textContent = pendingTasks;
            document.getElementById('total-study-time').textContent = `${totalStudyTime} min`;
            
            const progressBar = document.getElementById('overall-progress-bar');
            progressBar.style.width = `${progress}%`;
            document.getElementById('overall-progress-text').textContent = `${Math.round(progress)}% poora hua.`;

            const today = new Date().toISOString().split('T')[0];
            const todaysTasks = tasks.filter(t => t.dueDate === today && !t.isCompleted);
            const todaysTasksList = document.getElementById('todays-tasks-list');
            todaysTasksList.innerHTML = '';
            if (todaysTasks.length > 0) {
                todaysTasks.forEach(task => {
                    const subject = subjects.find(s => s.id === task.subjectId);
                    const taskEl = document.createElement('div');
                    taskEl.className = 'flex items-center justify-between text-sm';
                    taskEl.innerHTML = `
                        <span>${task.name}</span>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color:${subject?.color}20; color:${subject?.color};">${subject?.name || 'General'}</span>
                    `;
                    todaysTasksList.appendChild(taskEl);
                });
            } else {
                todaysTasksList.innerHTML = `<p class="text-gray-500">Shabash! Aaj ke liye koi pending task nahi hai.</p>`;
            }
        }
        
        function renderTimerTaskOptions() {
            const select = document.getElementById('task-for-timer');
            const pendingTasks = tasks.filter(t => !t.isCompleted);
            select.innerHTML = '<option value="">Koi task nahi chuna</option>';
            pendingTasks.forEach(task => {
                const subject = subjects.find(s => s.id === task.subjectId);
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `[${subject ? subject.name : 'N/A'}] ${task.name}`;
                select.appendChild(option);
            });
        }
        
        function renderReports() {
            if (studyTimeChart) {
                studyTimeChart.destroy();
            }

            const ctx = document.getElementById('study-time-chart').getContext('2d');
            const dataBySubject = {};

            subjects.forEach(subject => {
                dataBySubject[subject.id] = { name: subject.name, color: subject.color, time: 0 };
            });
            
            studySessions.forEach(session => {
                const task = tasks.find(t => t.id === session.taskId);
                if (task && dataBySubject[task.subjectId]) {
                    dataBySubject[task.subjectId].time += session.duration;
                }
            });

            const chartData = Object.values(dataBySubject);

            studyTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: chartData.map(d => d.time),
                        backgroundColor: chartData.map(d => d.color),
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- DATA MANIPULATION ---
        async function handleSubjectForm(e) {
            e.preventDefault();
            const name = document.getElementById('subject-name').value;
            const color = document.getElementById('subject-color').value;
            const subjectCollection = collection(db, `artifacts/${__app_id}/users/${userId}/subjects`);
            await addDoc(subjectCollection, { name, color, createdAt: new Date() });
            closeSubjectModal();
        }

        async function handleTaskForm(e) {
            e.preventDefault();
            const name = document.getElementById('task-name').value;
            const dueDate = document.getElementById('task-due-date').value;
            const subjectId = document.getElementById('task-subject-id').value;
            const taskCollection = collection(db, `artifacts/${__app_id}/users/${userId}/tasks`);
            await addDoc(taskCollection, { name, dueDate, subjectId, isCompleted: false, createdAt: new Date() });
            closeTaskModal();
        }
        
        async function toggleTaskCompletion(taskId, isCompleted) {
            const taskRef = doc(db, `artifacts/${__app_id}/users/${userId}/tasks`, taskId);
            await updateDoc(taskRef, { isCompleted });
        }

        // 3. Subject delete करने पर उससे जुड़े study sessions भी अब delete हो जाएंगे।
        async function deleteSubject(subjectId) {
            if (!confirm(`Kya aap is subject ko delete karna chahte hain? Iske sabhi tasks bhi delete ho jayenge.`)) return;
            
            try {
                const batch = writeBatch(db);
                const basePath = `artifacts/${__app_id}/users/${userId}`;

                // Delete subject
                batch.delete(doc(db, `${basePath}/subjects`, subjectId));

                // Find and delete associated tasks
                const tasksToDelete = tasks.filter(t => t.subjectId === subjectId);
                const taskIdsToDelete = tasksToDelete.map(t => t.id);
                taskIdsToDelete.forEach(taskId => {
                    batch.delete(doc(db, `${basePath}/tasks`, taskId));
                });

                // Find and delete associated study sessions
                if (taskIdsToDelete.length > 0) {
                    const sessionsQuery = query(collection(db, `${basePath}/studySessions`), where('taskId', 'in', taskIdsToDelete));
                    const sessionsSnapshot = await getDocs(sessionsQuery);
                    sessionsSnapshot.forEach(sessionDoc => {
                        batch.delete(sessionDoc.ref);
                    });
                }
                
                await batch.commit();
            } catch (error) {
                console.error("Error deleting subject and related data: ", error);
            }
        }


        // --- UI & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                    button.classList.add('tab-active');
                    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                });
            });

            document.getElementById('add-subject-btn').addEventListener('click', openSubjectModal);
            document.getElementById('cancel-subject-modal').addEventListener('click', closeSubjectModal);
            document.getElementById('subject-form').addEventListener('submit', handleSubjectForm);
            document.getElementById('cancel-task-modal').addEventListener('click', closeTaskModal);
            document.getElementById('task-form').addEventListener('submit', handleTaskForm);
            document.getElementById('close-alert-modal').addEventListener('click', () => document.getElementById('custom-alert-modal').style.display = 'none');
            document.getElementById('request-notification-permission').addEventListener('click', requestNotificationPermission);
            
            document.getElementById('subjects-list').addEventListener('click', (e) => {
                const addTaskBtn = e.target.closest('.add-task-btn');
                const deleteSubjectBtn = e.target.closest('.delete-subject-btn');
                const taskCheckbox = e.target.closest('.task-checkbox');

                if (addTaskBtn) openTaskModal(addTaskBtn.dataset.subjectId);
                if (deleteSubjectBtn) deleteSubject(deleteSubjectBtn.dataset.id);
                if (taskCheckbox) toggleTaskCompletion(taskCheckbox.dataset.id, taskCheckbox.checked);
            });
        });

        function openSubjectModal() {
            document.getElementById('subject-form').reset();
            document.getElementById('subject-modal').style.display = 'flex';
        }
        function closeSubjectModal() {
            document.getElementById('subject-modal').style.display = 'none';
        }
        function openTaskModal(subjectId) {
            document.getElementById('task-form').reset();
            document.getElementById('task-subject-id').value = subjectId;
            document.getElementById('task-modal').style.display = 'flex';
        }
        function closeTaskModal() {
            document.getElementById('task-modal').style.display = 'none';
        }

        // --- TIMER LOGIC ---
        let timerInterval;
        let timerState = 'stopped';
        let timerMode = 'work';
        let secondsRemaining = 25 * 60;
        const WORK_DURATION = 25 * 60;
        const BREAK_DURATION = 5 * 60;

        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-timer-btn');
        const pauseBtn = document.getElementById('pause-timer-btn');
        const resetBtn = document.getElementById('reset-timer-btn');
        const timerStatus = document.getElementById('timer-status');

        function updateTimerDisplay() {
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function startTimer() {
            if (timerState === 'running') return;
            timerState = 'running';
            startBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            timerInterval = setInterval(() => {
                secondsRemaining--;
                updateTimerDisplay();
                if (secondsRemaining < 0) {
                    clearInterval(timerInterval);
                    handleTimerEnd();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerState !== 'running') return;
            timerState = 'paused';
            clearInterval(timerInterval);
            startBtn.classList.remove('hidden');
            startBtn.textContent = 'Resume';
            pauseBtn.classList.add('hidden');
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerState = 'stopped';
            timerMode = 'work';
            secondsRemaining = WORK_DURATION;
            updateTimerDisplay();
            startBtn.classList.remove('hidden');
            startBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            pauseBtn.classList.add('hidden');
            timerStatus.textContent = 'Focus ka samay!';
        }
        
        async function handleTimerEnd() {
            if (timerMode === 'work') {
                const taskId = document.getElementById('task-for-timer').value;
                if (taskId) {
                    const sessionCollection = collection(db, `artifacts/${__app_id}/users/${userId}/studySessions`);
                    await addDoc(sessionCollection, { 
                        taskId,
                        duration: WORK_DURATION / 60,
                        completedAt: new Date()
                    });
                }
            }
            
            triggerAlerts();
            
            if (timerMode === 'work') {
                timerMode = 'break';
                secondsRemaining = BREAK_DURATION;
                timerStatus.textContent = "Chhota break!";
                showAlert('Timer Poora Hua!', 'Ab break lene ka samay hai.', 'break');
            } else {
                timerMode = 'work';
                secondsRemaining = WORK_DURATION;
                timerStatus.textContent = "Focus ka samay!";
                showAlert('Break Khatm!', 'Chaliye, padhai par wapas chalte hain.', 'work');
            }
            
            timerState = 'stopped';
            updateTimerDisplay();
            startBtn.classList.remove('hidden');
            startBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            pauseBtn.classList.add('hidden');
        }

        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);
        
        // --- NOTIFICATIONS & ALERTS ---
        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification("Notifications Enabled!", {
                        body: "Aapko timer poora hone par alert milega.",
                        icon: "https://placehold.co/48x48/3b82f6/ffffff?text=OK"
                    });
                }
            });
        }
        
        function triggerAlerts() {
            if (Notification.permission === "granted") {
                const bodyText = timerMode === 'work' ? 'Time for a short break!' : 'Break is over. Time to focus!';
                 new Notification('Study Timer Finished!', { body: bodyText, icon: "https://placehold.co/48x48/3b82f6/ffffff?text=🔔" });
            }
            if (document.getElementById('enable-sound').checked) {
                try {
                    new Tone.Synth().toDestination().triggerAttackRelease("C4", "8n");
                } catch(e) { console.error("Tone.js error:", e); }
            }
            if (document.getElementById('enable-vibration').checked && 'vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
        }
        
        function showAlert(title, message, type) {
            const modal = document.getElementById('custom-alert-modal');
            document.getElementById('custom-alert-title').textContent = title;
            document.getElementById('custom-alert-message').textContent = message;
            const iconDiv = document.getElementById('custom-alert-icon');
            iconDiv.innerHTML = (type === 'break') 
                ? `<i class="fas fa-coffee text-5xl text-yellow-500"></i>`
                : `<i class="fas fa-book-reader text-5xl text-green-500"></i>`;
            modal.style.display = 'flex';
        }

    </script>
</body>
</html>

