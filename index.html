<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Study Planner Pro</title>

    <!-- PWA and Mobile App Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Study Pro">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tone.js for audio alerts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            -webkit-tap-highlight-color: transparent; /* Removes tap highlight on mobile */
        }
        /* Styles for the main content to avoid overlap with fixed nav bar */
        main {
            padding-bottom: 80px; /* Space for the bottom nav */
        }
        /* Bottom Navigation Bar Styles */
        .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .nav-btn {
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active {
            color: #3b82f6;
            transform: translateY(-4px);
        }
        .nav-btn.active .nav-icon {
             background-color: #dbeafe;
             padding: 8px;
             border-radius: 9999px;
        }
        /* Custom modal animation */
        .modal-content {
            animation: scale-up 0.3s cubic-bezier(0.165, 0.840, 0.440, 1.000);
        }
        @keyframes scale-up {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #reports-tab, #reports-tab * {
                visibility: visible;
            }
            #reports-tab {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .print-header {
                visibility: visible !important;
                text-align: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container" class="max-w-4xl mx-auto min-h-screen">
        <!-- Top Header -->
        <header class="sticky top-0 bg-white/80 backdrop-blur-md z-10 p-4 shadow-sm no-print">
            <h1 id="header-title" class="text-xl font-bold text-center text-gray-800">Dashboard</h1>
        </header>

        <!-- Loading state -->
        <div id="loading-indicator" class="flex flex-col items-center justify-center h-screen">
            <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
            <p class="mt-4 text-gray-600">App load ho raha hai...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <main id="main-content" class="hidden p-4">
            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard-tab" class="tab-pane active-pane">
                    <!-- Dashboard content here -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Welcome & Stats -->
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Aaj ka Overview</h2>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center"><span class="text-gray-600"><i class="fas fa-tasks mr-2 text-green-500"></i>Poore kiye gaye Tasks</span><span id="completed-tasks-count" class="font-bold text-lg">0</span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600"><i class="fas fa-hourglass-half mr-2 text-red-500"></i>Baaki Tasks</span><span id="pending-tasks-count" class="font-bold text-lg">0</span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600"><i class="fas fa-stopwatch mr-2 text-blue-500"></i>Total Padhai ka Samay</span><span id="total-study-time" class="font-bold text-lg">0 min</span></div>
                            </div>
                        </div>
                        <!-- Today's Tasks -->
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Aaj ke Tasks</h2>
                            <div id="todays-tasks-list" class="space-y-3 max-h-48 overflow-y-auto">
                                <p class="text-gray-500">Aaj ke liye koi task nahi hai.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md mt-6">
                        <h2 class="text-2xl font-bold mb-4">Overall Progress</h2>
                        <div class="w-full bg-gray-200 rounded-full h-4"><div id="overall-progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill" style="width: 0%;"></div></div>
                        <p id="overall-progress-text" class="text-center mt-2 text-gray-600">0% poora hua.</p>
                    </div>
                </div>

                <!-- Subjects & Tasks Tab -->
                <div id="subjects-tab" class="tab-pane hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Aapke Subjects</h2>
                        <button id="add-subject-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition"><i class="fas fa-plus mr-2"></i>Naya</button>
                    </div>
                    <div id="subjects-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <p id="no-subjects-msg" class="text-gray-500 col-span-full text-center py-10">Aapne abhi tak koi subject add nahi kiya hai.</p>
                    </div>
                </div>

                <!-- Focus Timer Tab -->
                <div id="timer-tab" class="tab-pane hidden">
                     <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto text-center">
                        <h2 class="text-2xl font-bold mb-4">Focus Timer (Pomodoro)</h2>
                        <div id="timer-display" class="text-8xl font-bold my-6 text-gray-800">25:00</div>
                        <div class="mb-6">
                            <label for="task-for-timer" class="block text-sm font-medium text-gray-700 mb-2">Focus karne ke liye Task chunein:</label>
                            <select id="task-for-timer" class="w-full p-2 border border-gray-300 rounded-md bg-white"></select>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button id="start-timer-btn" class="bg-green-500 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow hover:bg-green-600 transition"><i class="fas fa-play mr-2"></i>Start</button>
                            <button id="pause-timer-btn" class="bg-yellow-500 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow hover:bg-yellow-600 transition hidden"><i class="fas fa-pause mr-2"></i>Pause</button>
                            <button id="reset-timer-btn" class="bg-red-500 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow hover:bg-red-600 transition"><i class="fas fa-sync-alt mr-2"></i>Reset</button>
                        </div>
                        <p id="timer-status" class="mt-4 text-gray-600">Focus ka samay!</p>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports-tab" class="tab-pane hidden">
                    <div class="print-header hidden">
                        <h1 class="text-3xl font-bold">Study Planner Pro - Report</h1>
                        <p id="report-date-print" class="text-gray-600"></p>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-bold">Aapki Study Report</h2>
                         <button id="print-report-btn" class="bg-gray-700 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-800 transition no-print"><i class="fas fa-print mr-2"></i>Print Report</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold mb-3">Subject ke anusaar Padhai ka Samay</h3>
                        <canvas id="study-time-chart" height="150"></canvas>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-pane hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                         <h2 class="text-2xl font-bold mb-4">Settings</h2>
                        <div class="flex items-center justify-between"><label class="font-medium">Browser Notifications</label><button id="request-notification-permission" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Enable Karein</button></div>
                        <div class="flex items-center justify-between"><label class="font-medium">Sound Alert</label><input type="checkbox" id="enable-sound" class="h-6 w-6 rounded text-blue-500 border-gray-300 focus:ring-blue-500"></div>
                        <div class="pt-4 border-t">
                            <h3 class="font-semibold mb-2">User ID</h3>
                            <p class="text-sm text-gray-500">Yeh aapki unique ID hai. Isse aap data recover kar sakte hain.</p>
                            <div class="mt-2 bg-gray-100 p-2 rounded-md text-center"><code id="user-id-display" class="text-gray-700"></code></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bottom Navigation Bar -->
    <footer class="bottom-nav fixed bottom-0 left-0 right-0 bg-white h-20 flex justify-around items-center max-w-4xl mx-auto rounded-t-2xl no-print">
        <button class="nav-btn active" data-tab="dashboard" data-title="Dashboard"><span class="nav-icon"><i class="fas fa-tachometer-alt fa-lg"></i></span><span class="text-xs block mt-1">Dashboard</span></button>
        <button class="nav-btn" data-tab="subjects" data-title="Subjects & Tasks"><span class="nav-icon"><i class="fas fa-book fa-lg"></i></span><span class="text-xs block mt-1">Subjects</span></button>
        <button class="nav-btn" data-tab="timer" data-title="Focus Timer"><span class="nav-icon"><i class="fas fa-clock fa-lg"></i></span><span class="text-xs block mt-1">Timer</span></button>
        <button class="nav-btn" data-tab="reports" data-title="Reports"><span class="nav-icon"><i class="fas fa-chart-pie fa-lg"></i></span><span class="text-xs block mt-1">Reports</span></button>
        <button class="nav-btn" data-tab="settings" data-title="Settings"><span class="nav-icon"><i class="fas fa-cog fa-lg"></i></span><span class="text-xs block mt-1">Settings</span></button>
    </footer>

    <!-- Modals (unchanged structure, just for completeness) -->
    <div id="subject-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="modal-content bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4" id="subject-modal-title">Naya Subject Jodein</h3><form id="subject-form"><div><label for="subject-name" class="block text-sm font-medium">Subject ka Naam</label><input type="text" id="subject-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div><div class="mt-4"><label for="subject-color" class="block text-sm font-medium">Ek Rang Chunein</label><input type="color" id="subject-color" class="mt-1 block w-full h-10" value="#3b82f6"></div><div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-subject-modal" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Save</button></div></form></div></div>
    <div id="task-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="modal-content bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4" id="task-modal-title">Naya Task Jodein</h3><form id="task-form"><input type="hidden" id="task-subject-id"><input type="hidden" id="task-id"><div><label for="task-name" class="block text-sm font-medium">Task ka Naam</label><input type="text" id="task-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div><div class="mt-4"><label for="task-due-date" class="block text-sm font-medium">Due Date</label><input type="date" id="task-due-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div><div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-task-modal" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Save Task</button></div></form></div></div>
    <div id="custom-alert-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"><div class="modal-content bg-white rounded-lg p-8 w-full max-w-sm text-center shadow-2xl"><div id="custom-alert-icon" class="mb-4"></div><h3 class="text-xl font-bold mb-2" id="custom-alert-title">Timer Poora Hua!</h3><p class="text-gray-600 mb-6" id="custom-alert-message">Ab break lene ka samay hai.</p><button id="close-alert-modal" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 w-full">Okay</button></div></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId = null, subjects = [], tasks = [], studySessions = [], studyTimeChart;
        const __app_id = "study-planner-pro";
        
        // --- FIREBASE SETUP ---
        function initializeFirebase() {
            try {
                // IMPORTANT: Yahaan apni Firebase project configuration paste karein
                const firebaseConfig = {
                    apiKey: "AIzaSyApJFN9a_iqI5xKvhU20N6pkkmNe12Cb2s",
                    authDomain: "study-manage-83992.firebaseapp.com",
                    projectId: "study-manage-83992",
                    storageBucket: "study-manage-83992.firebasestorage.app",
                    messagingSenderId: "827804856712",
                    appId: "1:827804856712:web:2e5629989deb773eb6ca3d"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        await fetchAllData();
                        hideLoadingIndicator();
                    } else {
                        await signInAnonymously(auth).catch(err => showError("Authentication failed."));
                    }
                });
            } catch (e) {
                showError("Could not connect to the database.");
            }
        }

        // --- UI & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            // Bottom Navigation Logic
            document.querySelector('.bottom-nav').addEventListener('click', (e) => {
                const button = e.target.closest('.nav-btn');
                if (!button) return;
                
                const tabName = button.dataset.tab;
                const tabTitle = button.dataset.title;

                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                
                button.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                document.getElementById('header-title').textContent = tabTitle;
            });

            // Modal Controls
            document.getElementById('add-subject-btn').addEventListener('click', openSubjectModal);
            document.getElementById('cancel-subject-modal').addEventListener('click', closeSubjectModal);
            document.getElementById('subject-form').addEventListener('submit', handleSubjectForm);
            document.getElementById('cancel-task-modal').addEventListener('click', closeTaskModal);
            document.getElementById('task-form').addEventListener('submit', handleTaskForm);
            document.getElementById('close-alert-modal').addEventListener('click', () => document.getElementById('custom-alert-modal').style.display = 'none');
            
            // Other Listeners
            document.getElementById('subjects-list').addEventListener('click', handleSubjectListClicks);
            document.getElementById('request-notification-permission').addEventListener('click', requestNotificationPermission);
            document.getElementById('print-report-btn').addEventListener('click', printReport);
        });
        
        // --- DATA FETCHING & RENDERING ---
        async function fetchAllData() {
            if (!userId) return;
            const basePath = `artifacts/${__app_id}/users/${userId}`;
            onSnapshot(collection(db, `${basePath}/subjects`), s => { subjects = s.docs.map(d => ({ id: d.id, ...d.data() })); renderSubjects(); updateAllUI(); });
            onSnapshot(collection(db, `${basePath}/tasks`), s => { tasks = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAllTasks(); updateAllUI(); });
            onSnapshot(collection(db, `${basePath}/studySessions`), s => { studySessions = s.docs.map(d => ({ id: d.id, ...d.data() })); updateAllUI(); });
        }
        
        function renderSubjects() {
            const list = document.getElementById('subjects-list');
            const noSubjectsMsg = document.getElementById('no-subjects-msg');
            list.innerHTML = '';
            if (subjects.length === 0) {
                 noSubjectsMsg.classList.remove('hidden');
                return;
            }
            noSubjectsMsg.classList.add('hidden');

            subjects.forEach(subject => {
                const subjectTasks = tasks.filter(t => t.subjectId === subject.id);
                const completedTasks = subjectTasks.filter(t => t.isCompleted).length;
                const progress = subjectTasks.length > 0 ? (completedTasks / subjectTasks.length) * 100 : 0;

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-md border-l-4';
                card.style.borderColor = subject.color;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-gray-800">${subject.name}</h3>
                        <div class="flex space-x-2 text-gray-400">
                            <button class="delete-subject-btn hover:text-red-500" data-id="${subject.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">${completedTasks} / ${subjectTasks.length} tasks poore hue.</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div class="h-2.5 rounded-full" style="width: ${progress}%; background-color: ${subject.color};"></div></div>
                    <div class="mt-4"><div class="task-list space-y-2" data-subject-id="${subject.id}"></div></div>
                    <button class="add-task-btn mt-3 text-blue-500 hover:text-blue-700 text-sm font-semibold" data-subject-id="${subject.id}"><i class="fas fa-plus-circle mr-1"></i>Naya Task Jodein</button>`;
                list.appendChild(card);
            });
            renderAllTasks();
        }

        function renderAllTasks() {
            document.querySelectorAll('.task-list').forEach(list => {
                const subjectId = list.dataset.subjectId;
                const subjectTasks = tasks.filter(t => t.subjectId === subjectId).sort((a,b) => a.isCompleted - b.isCompleted);
                list.innerHTML = subjectTasks.length > 0 ? subjectTasks.map(task => `
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                        <div class="flex items-center"><input type="checkbox" class="task-checkbox h-5 w-5 rounded text-blue-500 border-gray-300 mr-3" data-id="${task.id}" ${task.isCompleted ? 'checked' : ''}><span class="${task.isCompleted ? 'line-through text-gray-400' : ''}">${task.name}</span></div>
                        <span class="text-xs text-gray-500">${new Date(task.dueDate).toLocaleDateString('hi-IN', {day:'numeric', month:'short'})}</span>
                    </div>`).join('') : `<p class="text-xs text-gray-400 italic">Is subject ke liye koi task nahi hai.</p>`;
            });
        }
        
        function updateAllUI() { renderDashboard(); renderTimerTaskOptions(); renderReports(); }
        // All other helper functions (renderDashboard, renderTimerTaskOptions, etc.) and logic (timer, data manipulation) remain largely the same as the previous version.
        // The following includes the essential functions and any minor updates.
        
        function handleSubjectListClicks(e) {
            const addTaskBtn = e.target.closest('.add-task-btn');
            const deleteSubjectBtn = e.target.closest('.delete-subject-btn');
            const taskCheckbox = e.target.closest('.task-checkbox');

            if (addTaskBtn) openTaskModal(addTaskBtn.dataset.subjectId);
            if (deleteSubjectBtn) deleteSubject(deleteSubjectBtn.dataset.id);
            if (taskCheckbox) toggleTaskCompletion(taskCheckbox.dataset.id, taskCheckbox.checked);
        }

        async function handleSubjectForm(e) {
            e.preventDefault();
            const name = document.getElementById('subject-name').value.trim();
            const color = document.getElementById('subject-color').value;
            if (!name) return;
            await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/subjects`), { name, color, createdAt: new Date() });
            closeSubjectModal();
        }

        async function handleTaskForm(e) {
            e.preventDefault();
            const name = document.getElementById('task-name').value.trim();
            const dueDate = document.getElementById('task-due-date').value;
            const subjectId = document.getElementById('task-subject-id').value;
            if (!name || !dueDate || !subjectId) return;
            await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/tasks`), { name, dueDate, subjectId, isCompleted: false, createdAt: new Date() });
            closeTaskModal();
        }

        async function toggleTaskCompletion(taskId, isCompleted) {
            await updateDoc(doc(db, `artifacts/${__app_id}/users/${userId}/tasks`, taskId), { isCompleted });
        }
        
        async function deleteSubject(subjectId) {
            // Using a custom confirmation modal would be better, but confirm is simpler for now.
            if (!confirm("Kya aap sach mein is subject ko delete karna chahte hain? Iske sabhi tasks aur study data bhi delete ho jayenge.")) return;
            const batch = writeBatch(db);
            const basePath = `artifacts/${__app_id}/users/${userId}`;
            batch.delete(doc(db, `${basePath}/subjects`, subjectId));
            const tasksToDelete = tasks.filter(t => t.subjectId === subjectId);
            const taskIdsToDelete = tasksToDelete.map(t => t.id);
            taskIdsToDelete.forEach(id => batch.delete(doc(db, `${basePath}/tasks`, id)));
            const sessionsQuery = query(collection(db, `${basePath}/studySessions`), where('taskId', 'in', taskIdsToDelete.length > 0 ? taskIdsToDelete : ['']));
            const sessionsSnapshot = await getDocs(sessionsQuery);
            sessionsSnapshot.forEach(sessionDoc => batch.delete(sessionDoc.ref));
            await batch.commit();
        }

        function printReport() {
            document.getElementById('report-date-print').textContent = `Report generated on: ${new Date().toLocaleDateString('hi-IN')}`;
            window.print();
        }
        
        function hideLoadingIndicator() {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }
        
        function showError(message) {
            document.getElementById('loading-indicator').innerHTML = `<p class="text-red-500 font-bold p-4">${message}</p>`;
        }
        
        // Modal functions
        function openSubjectModal() { document.getElementById('subject-form').reset(); document.getElementById('subject-modal').style.display = 'flex'; }
        function closeSubjectModal() { document.getElementById('subject-modal').style.display = 'none'; }
        function openTaskModal(subjectId) { document.getElementById('task-form').reset(); document.getElementById('task-subject-id').value = subjectId; document.getElementById('task-modal').style.display = 'flex'; }
        function closeTaskModal() { document.getElementById('task-modal').style.display = 'none'; }

        // Other rendering functions (Dashboard, Reports, Timer Options) would go here, they are mostly unchanged from your previous code.
        // For brevity, I'll include the reports one as it's relevant to the print feature.
        function renderDashboard(){const c=tasks.filter(t=>t.isCompleted).length,p=tasks.length-c,s=studySessions.reduce((a,s)=>a+s.duration,0),r=tasks.length>0?c/tasks.length*100:0;document.getElementById("completed-tasks-count").textContent=c,document.getElementById("pending-tasks-count").textContent=p,document.getElementById("total-study-time").textContent=`${s} min`,document.getElementById("overall-progress-bar").style.width=`${r}%`,document.getElementById("overall-progress-text").textContent=`${Math.round(r)}% poora hua.`;const d=new Date().toISOString().split("T")[0],l=tasks.filter(t=>t.dueDate===d&&!t.isCompleted),t=document.getElementById("todays-tasks-list");t.innerHTML="",l.length>0?l.forEach(e=>{const s=subjects.find(s=>s.id===e.subjectId),o=document.createElement("div");o.className="flex items-center justify-between text-sm",o.innerHTML=`<span>${e.name}</span> <span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color:${s?.color}20; color:${s?.color};">${s?.name||"General"}</span>`,t.appendChild(o)}):t.innerHTML='<p class="text-gray-500">Shabash! Aaj ke liye koi pending task nahi hai.</p>'}
        function renderTimerTaskOptions(){const t=document.getElementById("task-for-timer"),e=tasks.filter(t=>!t.isCompleted);for(t.innerHTML='<option value="">Koi task nahi chuna</option>',e.forEach(e=>{const s=subjects.find(s=>s.id===e.subjectId),o=document.createElement("option");o.value=e.id,o.textContent=`[${s?s.name:"N/A"}] ${e.name}`,t.appendChild(o)})}
        function renderReports(){if(studyTimeChart)studyTimeChart.destroy();const t=document.getElementById("study-time-chart").getContext("2d"),e={};subjects.forEach(t=>{e[t.id]={name:t.name,color:t.color,time:0}}),studySessions.forEach(s=>{const o=tasks.find(t=>t.id===s.taskId);o&&e[o.subjectId]&&(e[o.subjectId].time+=s.duration)});const s=Object.values(e);studyTimeChart=new Chart(t,{type:"bar",data:{labels:s.map(t=>t.name),datasets:[{label:"Study Time (minutes)",data:s.map(t=>t.time),backgroundColor:s.map(t=>t.color),borderWidth:1}]},options:{responsive:!0,scales:{y:{beginAtZero:!0}},plugins:{legend:{display:!1}}}})}
        
        // Timer Logic (largely unchanged)
        let timerInterval,timerState="stopped",timerMode="work",secondsRemaining=1500;const WORK_DURATION=1500,BREAK_DURATION=300,timerDisplay=document.getElementById("timer-display"),startBtn=document.getElementById("start-timer-btn"),pauseBtn=document.getElementById("pause-timer-btn"),resetBtn=document.getElementById("reset-timer-btn"),timerStatus=document.getElementById("timer-status");function updateTimerDisplay(){const e=Math.floor(secondsRemaining/60),t=secondsRemaining%60;timerDisplay.textContent=`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function startTimer(){"running"!==timerState&&(timerState="running",startBtn.classList.add("hidden"),pauseBtn.classList.remove("hidden"),timerInterval=setInterval(()=>{secondsRemaining--,updateTimerDisplay(),secondsRemaining<0&&(clearInterval(timerInterval),handleTimerEnd())},1e3))}function pauseTimer(){"running"===timerState&&(timerState="paused",clearInterval(timerInterval),startBtn.classList.remove("hidden"),startBtn.textContent="Resume",pauseBtn.classList.add("hidden"))}function resetTimer(){clearInterval(timerInterval),timerState="stopped",timerMode="work",secondsRemaining=WORK_DURATION,updateTimerDisplay(),startBtn.classList.remove("hidden"),startBtn.innerHTML='<i class="fas fa-play mr-2"></i>Start',pauseBtn.classList.add("hidden"),timerStatus.textContent="Focus ka samay!"}async function handleTimerEnd(){if("work"===timerMode){const e=document.getElementById("task-for-timer").value;e&&await addDoc(collection(db,`artifacts/${__app_id}/users/${userId}/studySessions`),{taskId:e,duration:WORK_DURATION/60,completedAt:new Date})}triggerAlerts(),"work"===timerMode?(timerMode="break",secondsRemaining=BREAK_DURATION,timerStatus.textContent="Chhota break!",showAlert("Timer Poora Hua!","Ab break lene ka samay hai.","break")):(timerMode="work",secondsRemaining=WORK_DURATION,timerStatus.textContent="Focus ka samay!",showAlert("Break Khatm!","Chaliye, padhai par wapas chalte hain.","work")),timerState="stopped",updateTimerDisplay(),startBtn.classList.remove("hidden"),startBtn.innerHTML='<i class="fas fa-play mr-2"></i>Start',pauseBtn.classList.add("hidden")}startBtn.addEventListener("click",startTimer),pauseBtn.addEventListener("click",pauseTimer),resetBtn.addEventListener("click",resetTimer);
        
        // Notifications and Alerts (unchanged)
        function requestNotificationPermission(){Notification.requestPermission().then(e=>{"granted"===e&&new Notification("Notifications Enabled!",{body:"Aapko timer poora hone par alert milega.",icon:"https://placehold.co/48x48/3b82f6/ffffff?text=OK"})})}function triggerAlerts(){if("granted"===Notification.permission){const e="work"===timerMode?"Time for a short break!":"Break is over. Time to focus!";new Notification("Study Timer Finished!",{body:e,icon:"https://placehold.co/48x48/3b82f6/ffffff?text=🔔"})}document.getElementById("enable-sound").checked&&new Tone.Synth().toDestination().triggerAttackRelease("C4","8n"),"vibrate"in navigator&&navigator.vibrate([200,100,200])}function showAlert(e,t,o){const n=document.getElementById("custom-alert-modal");document.getElementById("custom-alert-title").textContent=e,document.getElementById("custom-alert-message").textContent=t,document.getElementById("custom-alert-icon").innerHTML="break"===o?'<i class="fas fa-coffee text-5xl text-yellow-500"></i>':'<i class="fas fa-book-reader text-5xl text-green-500"></i>',n.style.display="flex"}
    </script>
    
    <!-- Service Worker Registration Script -->
    <script class="no-print">
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service worker registered.', reg))
                    .catch(err => console.log('Service worker registration failed: ', err));
            });
        }
    </script>

</body>
</html>
